# Data Model: Scaffold Command

**Feature**: 002-scaffold-command  
**Date**: 2026-01-11

## Entities

### 1. PluginManifest (Input)

The source Claude Code plugin manifest at `.claude-plugin/plugin.json`.

```typescript
interface PluginManifest {
  name: string;           // Required: Plugin identifier (e.g., "phil-ai-learning")
  version: string;        // Required: Semver (e.g., "1.0.0")
  description: string;    // Required: Brief description
  author?: {
    name: string;         // Required if author present
    email?: string;       // Optional
    url?: string;         // Optional
  };
  repository?: string;    // Optional: Git URL
  license?: string;       // Optional: SPDX identifier (default: "MIT")
  homepage?: string;      // Optional: Project URL
}
```

**Validation Rules**:
- `name`: Non-empty string, valid npm package name format
- `version`: Valid semver (regex: `/^\d+\.\d+\.\d+/`)
- `description`: Non-empty string

**Source**: `.claude-plugin/plugin.json`

---

### 2. CommandFile (Input)

A markdown command definition at `commands/*.md`.

```typescript
interface CommandFile {
  path: string;           // Relative path (e.g., "commands/learn.md")
  name: string;           // Derived from filename (e.g., "learn")
  frontmatter: {
    description?: string; // Command description
    agent?: string;       // Optional agent override
    model?: string;       // Optional model override
    subtask?: boolean;    // Whether this is a subtask command
  };
  template: string;       // Command body (after frontmatter)
}
```

**Validation Rules**:
- File must be valid markdown
- Frontmatter is optional but parsed if present
- Name derived from filename with `.md` stripped

**Source**: `commands/*.md` (recursive glob)

---

### 3. SkillFile (Input)

A skill definition at `skills/{name}/SKILL.md`.

```typescript
interface SkillFile {
  path: string;           // Full path to SKILL.md
  name: string;           // Derived from parent directory name
  frontmatter: {
    name?: string;        // Explicit name (overrides directory)
    description?: string; // Skill description for tool registration
  };
  content: string;        // Full skill content (for reference)
}
```

**Validation Rules**:
- File must exist at `skills/{name}/SKILL.md`
- `description` required in frontmatter for tool generation
- Directory name used as fallback for `name`

**Source**: `skills/*/SKILL.md` (one level deep)

---

### 4. ScaffoldOutput (Output)

The collection of files generated by the scaffold command.

```typescript
interface ScaffoldOutput {
  files: GeneratedFile[];
  warnings: string[];
}

interface GeneratedFile {
  path: string;           // Relative to plugin root
  content: string;        // File content
  overwrite: boolean;     // Whether this overwrites existing file
}
```

**Generated Files**:

| File | Purpose | Template Source |
|------|---------|-----------------|
| `src/index.ts` | OpenCode plugin entry | Constitution lines 206-301 |
| `.opencode/plugin/<name>.ts` | Local testing copy | Same as src/index.ts |
| `package.json` | npm package manifest | Constitution lines 305-344 |
| `tsconfig.json` | TypeScript config | Constitution lines 349-365 |
| `.claude-plugin/marketplace.json` | Dev marketplace | Pattern from superpowers |
| `.gitignore` (update) | Add dist/, node_modules/ | Append if missing |

---

### 5. ScaffoldOptions (Runtime)

CLI options for the scaffold command.

```typescript
interface ScaffoldOptions {
  path: string;           // Target directory (default: cwd)
  dryRun: boolean;        // Preview without writing (default: false)
  force: boolean;         // Overwrite without prompting (default: false)
}
```

**Flag Mapping**:
- `--path=<dir>` or `-p <dir>` → `path`
- `--dry-run` → `dryRun`
- `--force` or `-f` → `force`

---

## Transformations

### 1. PluginManifest → package.json

```typescript
function transformToPackageJson(manifest: PluginManifest): string {
  return {
    name: manifest.name,
    version: manifest.version,
    description: manifest.description,
    author: manifest.author,
    license: manifest.license ?? "MIT",
    repository: manifest.repository ? {
      type: "git",
      url: manifest.repository
    } : undefined,
    // ... rest from template
  };
}
```

### 2. CommandFile[] → config hook registration

```typescript
// At runtime in generated plugin:
function loadCommands(): ParsedCommand[] {
  // Glob commands/*.md
  // Parse frontmatter
  // Return array of { name, frontmatter, template }
}

// In config hook:
for (const cmd of commands) {
  config.command[cmd.name] = {
    template: cmd.template,
    description: cmd.frontmatter.description,
    // ...
  };
}
```

### 3. SkillFile → tool stub

```typescript
function transformSkillToTool(skill: SkillFile): string {
  return `
    ${skill.name}: tool({
      description: '${skill.frontmatter.description ?? skill.name}',
      args: {},
      execute: async (args, context) => {
        return \`Tool "${skill.name}" not yet implemented. See skills/${skill.name}/SKILL.md for instructions.\`;
      }
    })
  `;
}
```

---

## State Transitions

The scaffold command is stateless - it reads inputs, generates outputs, and exits. No persistent state is maintained between runs.

**Workflow**:
```
[Input Validation] → [Metadata Extraction] → [Template Rendering] → [File Writing]
     ↓ error              ↓ continue              ↓ continue           ↓ done
   Exit(1)             warnings[]              GeneratedFile[]      Success
```

---

## Zod Schemas

```typescript
import { z } from 'zod';

export const PluginManifestSchema = z.object({
  name: z.string().min(1, "Plugin name is required"),
  version: z.string().regex(/^\d+\.\d+\.\d+/, "Invalid version format"),
  description: z.string().min(1, "Description is required"),
  author: z.object({
    name: z.string().min(1),
    email: z.string().email().optional(),
    url: z.string().url().optional(),
  }).optional(),
  repository: z.string().url().optional(),
  license: z.string().optional(),
  homepage: z.string().url().optional(),
});

export const CommandFrontmatterSchema = z.object({
  description: z.string().optional(),
  agent: z.string().optional(),
  model: z.string().optional(),
  subtask: z.boolean().optional(),
});

export const SkillFrontmatterSchema = z.object({
  name: z.string().optional(),
  description: z.string().optional(),
});
```

---

## File Relationships

```
.claude-plugin/plugin.json (input)
         ↓
    [scaffold command]
         ↓
├── src/index.ts (generated - canonical)
├── .opencode/plugin/<name>.ts (generated - copy)
├── package.json (generated)
├── tsconfig.json (generated)
├── .claude-plugin/marketplace.json (generated - dev)
└── .gitignore (updated)

commands/*.md (preserved - read only)
skills/*/SKILL.md (preserved - read only)
```
